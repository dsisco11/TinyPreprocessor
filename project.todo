TinyPreprocessor Project Plan:

Phase 1 - Project Setup:
  Phase 1.1 - Architectural Documentation:
    ✔ Create docs/ folder at workspace root @done(26-01-08 19:39)
    ✔ Document Core abstractions architecture (ResourceId, IResource, IDirective, IResourceResolver, IDirectiveParser) @done(26-01-08 19:39)
    ✔ Document Diagnostics system architecture (severity levels, diagnostic types, collection) @done(26-01-08 19:39)
    ✔ Document Dependency Graph architecture (Graffs integration, cycle detection, topological sorting) @done(26-01-08 19:39)
    ✔ Document Source Mapping architecture (positions, spans, mappings, query system) @done(26-01-08 19:39)
    ✔ Document Merge System architecture (strategies, context, directive stripping) @done(26-01-08 19:39)
    ✔ Document Preprocessor orchestrator architecture (processing flow, caching, options) @done(26-01-08 19:39)
  Phase 1.2 - Solution Structure:
    ✔ Create TinyPreprocessor.sln at workspace root @done(26-01-07 18:15)
    ✔ Create src/TinyPreprocessor/TinyPreprocessor.csproj (net8.0, nullable enabled) @done(26-01-07 18:15)
  ✔ Add PackageReference to Graffs 0.1.0 @done(26-01-08 19:45)
  ✔ Create tests/TinyPreprocessor.Tests/TinyPreprocessor.Tests.csproj @done(26-01-08 19:46)
  ✔ Add xUnit and Moq package references to test project @done(26-01-08 19:46)
  ✔ Add project reference from test project to main library @done(26-01-08 19:46)

Phase 2 - Core Abstractions (src/TinyPreprocessor/Core/):
  ✔ Create ResourceId readonly struct @done(26-01-08 20:00)
    ✔ Wrap string Path property @done(26-01-08 20:00)
    ✔ Implement IEquatable<ResourceId> @done(26-01-08 20:00)
    ✔ Override GetHashCode() and Equals() @done(26-01-08 20:00)
    ✔ Add implicit/explicit conversion operators @done(26-01-08 20:00)
  ✔ Create IResource interface @done(26-01-08 20:00)
    ✔ ResourceId Id property @done(26-01-08 20:00)
    ✔ ReadOnlyMemory<char> Content property @done(26-01-08 20:00)
    ✔ IReadOnlyDictionary<string, object>? Metadata property @done(26-01-08 20:00)
  ✔ Create Resource sealed record implementing IResource @done(26-01-08 20:00)
  ✔ Create IDirective marker interface @done(26-01-08 20:00)
    ✔ Range Location property @done(26-01-08 20:00)
  ✔ Create IResourceResolver interface @done(26-01-08 20:00)
    ✔ ValueTask<ResourceResolutionResult> ResolveAsync(string reference, IResource? relativeTo, CancellationToken ct) @done(26-01-08 20:00)
  ✔ Create ResourceResolutionResult record @done(26-01-08 20:00)
    ✔ IResource? Resource property @done(26-01-08 20:00)
    ✔ IPreprocessorDiagnostic? Error property @done(26-01-08 20:00)
  ✔ Create IDirectiveParser<TDirective> interface @done(26-01-08 20:00)
    ✔ IEnumerable<TDirective> Parse(ReadOnlyMemory<char> content, ResourceId resourceId) where TDirective : IDirective @done(26-01-08 20:00)

Phase 3 - Diagnostics System (src/TinyPreprocessor/Diagnostics/):
  ✔ Create DiagnosticSeverity enum (Info = 0, Warning = 1, Error = 2) @done(26-01-08 20:05)
  ✔ Create IPreprocessorDiagnostic interface @done(26-01-08 20:05)
    ✔ DiagnosticSeverity Severity property @done(26-01-08 20:05)
    ✔ string Code property @done(26-01-08 20:05)
    ✔ string Message property @done(26-01-08 20:05)
    ✔ ResourceId? Resource property @done(26-01-08 20:05)
    ✔ Range? Location property @done(26-01-08 20:05)
  ✔ Create CircularDependencyDiagnostic sealed record @done(26-01-08 20:05)
    ✔ Implement IPreprocessorDiagnostic @done(26-01-08 20:05)
    ✔ IReadOnlyList<ResourceId> Cycle property @done(26-01-08 20:05)
    ✔ Code = "TPP0001" @done(26-01-08 20:05)
  ✔ Create ResolutionFailedDiagnostic sealed record @done(26-01-08 20:05)
    ✔ Implement IPreprocessorDiagnostic @done(26-01-08 20:05)
    ✔ string Reference property @done(26-01-08 20:05)
    ✔ Code = "TPP0002" @done(26-01-08 20:05)
  ✔ Create ParseErrorDiagnostic sealed record @done(26-01-08 20:05)
    ✔ Implement IPreprocessorDiagnostic @done(26-01-08 20:05)
    ✔ Code = "TPP0003" @done(26-01-08 20:05)
  ✔ Create DiagnosticCollection sealed class @done(26-01-08 20:05)
    ✔ Thread-safe with lock @done(26-01-08 20:05)
    ✔ void Add(IPreprocessorDiagnostic) method @done(26-01-08 20:05)
    ✔ bool HasErrors property @done(26-01-08 20:05)
    ✔ Implement IReadOnlyCollection<IPreprocessorDiagnostic> @done(26-01-08 20:05)

Phase 4 - Dependency Graph Layer (src/TinyPreprocessor/Graph/):
  ✔ Create ResourceDependencyGraph sealed class @done(26-01-08 20:10)
    ✔ Internal DependencyGraphBuilder<ResourceId> field @done(26-01-08 20:10)
    ✔ void AddResource(ResourceId id) method @done(26-01-08 20:10)
    ✔ void AddDependency(ResourceId dependent, ResourceId dependency) method @done(26-01-08 20:10)
    ✔ IReadOnlyList<IReadOnlyList<ResourceId>> DetectCycles() method using CycleDetection.FindAllCycles() @done(26-01-08 20:10)
    ✔ IReadOnlyList<ResourceId> GetProcessingOrder() method using TopologicalSort.KahnSort() @done(26-01-08 20:10)

Phase 5 - Source Mapping System (src/TinyPreprocessor/SourceMaps/):
  ✔ Create SourcePosition readonly struct @done(26-01-08 20:15)
    ✔ int Line property (0-based) @done(26-01-08 20:15)
    ✔ int Column property (0-based) @done(26-01-08 20:15)
    ✔ Implement IComparable<SourcePosition> @done(26-01-08 20:15)
    ✔ Implement IEquatable<SourcePosition> @done(26-01-08 20:15)
  ✔ Create SourceSpan readonly struct @done(26-01-08 20:15)
    ✔ SourcePosition Start property @done(26-01-08 20:15)
    ✔ SourcePosition End property @done(26-01-08 20:15)
  ✔ Create SourceMapping sealed record @done(26-01-08 20:15)
    ✔ SourceSpan GeneratedSpan property @done(26-01-08 20:15)
    ✔ ResourceId OriginalResource property @done(26-01-08 20:15)
    ✔ SourceSpan OriginalSpan property @done(26-01-08 20:15)
  ✔ Create SourceLocation sealed record @done(26-01-08 20:15)
    ✔ ResourceId Resource property @done(26-01-08 20:15)
    ✔ SourcePosition OriginalPosition property @done(26-01-08 20:15)
  ✔ Create SourceMap sealed class @done(26-01-08 20:15)
    ✔ IReadOnlyList<SourceMapping> Mappings property (sorted by generated position) @done(26-01-08 20:15)
    ✔ SourceLocation? Query(SourcePosition generatedPosition) method with binary search @done(26-01-08 20:15)
  ✔ Create SourceMapBuilder sealed class @done(26-01-08 20:15)
    ✔ Internal List<SourceMapping> for accumulation @done(26-01-08 20:15)
    ✔ void AddMapping(SourceMapping) method @done(26-01-08 20:15)
    ✔ void AddSegment(ResourceId resource, SourceSpan generated, SourceSpan original) method @done(26-01-08 20:15)
    ✔ SourceMap Build() method (sorts and returns immutable) @done(26-01-08 20:15)

Phase 6 - Merge System (src/TinyPreprocessor/Merging/):
  ✔ Create ResolvedResource sealed record @done(26-01-08 20:20)
    ✔ IResource Resource property @done(26-01-08 20:20)
    ✔ IReadOnlyList<IDirective> Directives property @done(26-01-08 20:20)
  ✔ Create MergeContext sealed class @done(26-01-08 20:20)
    ✔ SourceMapBuilder SourceMapBuilder property @done(26-01-08 20:20)
    ✔ DiagnosticCollection Diagnostics property @done(26-01-08 20:20)
    ✔ IReadOnlyDictionary<ResourceId, IResource> ResolvedCache property @done(26-01-08 20:20)
  ✔ Create IMergeStrategy<TContext> interface @done(26-01-08 20:20)
    ✔ ReadOnlyMemory<char> Merge(IReadOnlyList<ResolvedResource> orderedResources, TContext userContext, MergeContext context) @done(26-01-08 20:20)
  ✔ Create ConcatenatingMergeStrategy<TContext> sealed class @done(26-01-08 20:20)
    ✔ Implement IMergeStrategy<TContext> @done(26-01-08 20:20)
    ✔ Iterate resources in topological order @done(26-01-08 20:20)
    ✔ Strip directive ranges from content @done(26-01-08 20:20)
    ✔ Append to StringBuilder @done(26-01-08 20:20)
    ✔ Record mappings via MergeContext.SourceMapBuilder @done(26-01-08 20:20)

Phase 7 - Main Orchestrator (src/TinyPreprocessor/):
  ✔ Create PreprocessorOptions sealed record @done(26-01-08 20:25)
    ✔ bool DeduplicateIncludes = true @done(26-01-08 20:25)
    ✔ int MaxIncludeDepth = 100 @done(26-01-08 20:25)
  ✔ Create PreprocessResult sealed record @done(26-01-08 20:25)
    ✔ ReadOnlyMemory<char> Content property @done(26-01-08 20:25)
    ✔ SourceMap SourceMap property @done(26-01-08 20:25)
    ✔ DiagnosticCollection Diagnostics property @done(26-01-08 20:25)
    ✔ bool Success => !Diagnostics.HasErrors @done(26-01-08 20:25)
  ✔ Create Preprocessor<TDirective, TContext> sealed class @done(26-01-08 20:25)
    ✔ Constructor accepting IDirectiveParser<TDirective>, IResourceResolver, IMergeStrategy<TContext> @done(26-01-08 20:25)
    ✔ Internal per-call cache Dictionary<ResourceId, ResolvedResource> @done(26-01-08 20:25)
    ✔ ValueTask<PreprocessResult> ProcessAsync(IResource root, TContext context, PreprocessorOptions? options, CancellationToken ct) @done(26-01-08 20:25)
    ✔ Implement recursive resolution with depth tracking @done(26-01-08 20:25)
    ✔ Implement deduplication logic based on options @done(26-01-08 20:25)
    ✔ Wire up cycle detection → CircularDependencyDiagnostic @done(26-01-08 20:25)
    ✔ Wire up topological sorting @done(26-01-08 20:25)
    ✔ Wire up merge strategy invocation @done(26-01-08 20:25)
    ✔ Build final PreprocessResult @done(26-01-08 20:25)

Phase 8 - Unit Tests (tests/TinyPreprocessor.Tests/):
  ✔ Core tests @done(26-01-08 22:35)
    ✔ ResourceId equality and hashing tests @done(26-01-08 22:35)
    ✔ Resource record tests @done(26-01-08 22:35)
  ✔ Diagnostics tests @done(26-01-08 22:35)
    ✔ DiagnosticCollection thread-safety tests @done(26-01-08 22:35)
    ✔ HasErrors logic tests @done(26-01-08 22:35)
  ✔ Graph tests @done(26-01-08 22:35)
    ✔ Cycle detection with known circular graphs @done(26-01-08 22:35)
    ✔ Topological sort ordering verification @done(26-01-08 22:35)
    ✔ Empty graph edge cases @done(26-01-08 22:35)
  ✔ SourceMap tests @done(26-01-08 22:35)
    ✔ SourcePosition comparison tests @done(26-01-08 22:35)
    ✔ SourceMapBuilder accumulation tests @done(26-01-08 22:35)
    ✔ SourceMap.Query binary search tests @done(26-01-08 22:35)
  ✔ Merge tests @done(26-01-08 22:35)
    ✔ ConcatenatingMergeStrategy output verification @done(26-01-08 22:35)
    ✔ Directive stripping tests @done(26-01-08 22:35)
    ✔ Source mapping accuracy tests @done(26-01-08 22:35)
  ✔ Integration tests @done(26-01-08 22:35)
    ✔ Full preprocessing pipeline with mock resolver/parser @done(26-01-08 22:35)
    ✔ Circular dependency handling (continues with diagnostics) @done(26-01-08 22:35)
    ✔ Deduplication behavior @done(26-01-08 22:35)
    ✔ MaxIncludeDepth enforcement @done(26-01-08 22:35)
